/* Oktell-panel.js 0.1.2 http://js.oktell.ru/webpanel */

<<<<<<< HEAD
var __indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty;(function(t){var e,n,s,i,o,r,l,a,u,c,d,h,p,f,b,m,g,v,_,y,w,k,E,C,A,L,x,H,U,B,F,P,j;if(!t)throw Error("Error init oktell panel, jQuery ( $ ) is not defined");return u=function(t,e,n){var s;return s="",function(){var i,o,r,l,a;return r=this,i=arguments,l=function(){var e;return s=null,n?void 0:e=t.apply(r,i)},o=n&&!s,clearTimeout(s),s=setTimeout(l,e),o&&(a=t.apply(r,i)),a}},d=function(t){return(""+t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},g=function(e){var n,s,i,o,r,l,a,u,c,d,h,p,f,b,m,g,v,_,y,w,k,E,C,A,L,x,H,U,B,F;return F="",A="",E="",C="",L="",h="",p="",f="",m="",g="",x="",b={},y=function(t,e,n){var s;return t=t.originalEvent,s=t.detail?-14*t.detail:t.wheelDelta/3,g=a(n),p=l(t),(g>=0&&s>0||g+s>0)&&(s=0,g=0),(e.height()-n.height()>=g&&0>s||e.height()-n.height()>g+s)&&(g=e.height()-n.height(),s=0),m=g+s},v=function(e,o,u,d,v){var y,E;if(e.type===i){if(b.noMoveMouse)return;return f=l(e),g=a(u),x=!0,t("body").css({"-moz-user-select":"none","-ms-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-webkit-touch-callout":"none","user-select":"none"})}if(e.type===s){if(!x)return;return c&&k(v),y=r(o,u),p=l(e),h?(m=g*y-(p-f),m/=y):m=g+(p-f),m>=0&&(g=a(u),f=p,m=0),E=o.height()-u.height(),E>=m&&(g=a(u),f=p,m=E),_(m,o,u,d,v),b.noMoveMouse=!0}if(e.type===n){if(!x)return;if(x=!1,h=!1,c&&w(v),t("body").css({"-moz-user-select":"","-ms-user-select":"","-khtml-user-select":"","-webkit-user-select":"","-webkit-touch-callout":"","user-select":""}),L)return w(v)}},_=function(t,e,n,s,i){return k(i),U(n,t),H(e,n,s,i)},l=function(t){return c?t.originalEvent.targetTouches[0].clientY:t.clientY},U=function(t,e){return t.css({position:"relative",top:e})},a=function(t){var e;return e=t.css("top"),"auto"===e&&(e=0),parseInt(e)},r=function(t,e){var n,s,i;return i=t.height(),s=e.height(),n=i/s},k=function(t){return t.stop(!0,!0),t.fadeIn(100)},w=function(t){return t.stop(!0,!0),t.fadeOut("slow")},H=function(t,e,n,s){var i,o,l,u,c,d,h,p;return i=n.height(),l=r(t,e),o=i*l,h=l>=1?"hidden":"visible",s.css({height:o,visibility:h}),d=a(e),p=t.height(),c=e.height(),0>=d&&p-c>=d&&(m=p-c,m=Math.min(m,0),U(e,m)),u=d/p,m=p*u,U(s,-1*m*l),null!=b?"function"==typeof b.onScroll?b.onScroll({wrapper:t,scroller:e,position:d,length:c}):void 0:void 0},x=!1,h=!1,B=/webkit/i.test(navigator.appVersion)?"webkit":/firefox/i.test(navigator.userAgent)?"Moz":__indexOf.call(window,"opera")>=0?"O":"",c=window.ontouchstart!==void 0,i=c?"touchstart":"mousedown",s=c?"touchmove":"mousemove",n=c?"touchend":"mouseup",o="Moz"===B?"DOMMouseScroll":"mousewheel",!c&&t(".jscroll_wrapper",e).size()||(u=function(){var n,s,i;return e.wrapInner('<div class="jscroll_wrapper" />'),F=t(".jscroll_wrapper",e),F.attr("id","jscroll_id"+Math.round(1e7*Math.random())),A=F.wrapInner('<div class="jscroll_scroller" />'),A=t(".jscroll_scroller",F),E=t('<div class="jscroll_scrollbar_cont"></div>').insertAfter(A),E.css({position:"absolute",right:"0px",width:"13px",top:"3px",bottom:"6px"}),C=t('<div class="jscroll_scrollbar_inner"></div>').appendTo(E),C.css({position:"relative",width:"100%",display:"none",opacity:"0.4",cursor:"pointer"}),s=t('<div class="jscroll_scrollbar_bar"></div>').appendTo(C),s.css({position:"relative",background:"black",width:"5px",margin:"0 auto","border-radius":"3px",height:"100%","-webkit-border-radius":"3px"}),F.css({position:"relative",height:"100%",overflow:"hidden"}),A.css({"min-height":"100%",overflow:"hidden"}),c?(A.after('<div class="jscroll_scroller_inner" />'),i=t(".jscroll_scroller_inner",F),i.appendTo("<div></div>"),null!=window.iScroll&&(n=new window.iScroll(F.attr("id"),{hScrollbar:!1,scrollbarClass:"jscroll_scroller_inner",checkDOMChanges:!0,bounceLock:!0,onScrollMove:function(){return b.onScroll(),!0},onScrollEnd:function(){return b.onScroll(),!0}})),!0):H(F,A,E,C)},u(),c)?void 0:(d=[],F.bind("resize",function(){var t;t=F.attr("id"),d[t]!==void 0&&clearTimeout(d[t]),d[t]=setTimeout(function(){return H(F,A,E,C),delete d[t]},100)}),c||F.hover(function(){L=!1,H(F,A,E,C),k(C)},function(){L=!0,x||w(C)}),C.bind(i,function(){return h=!0,b.noMoveMouse=!1,!0}),F.bind(i,function(t){return v(t,F,A,E,C),!0}),t(document).bind(s,function(t){return v(t,F,A,E,C),!0}),t(document).bind(n,function(t){return v(t,F,A,E,C),!0}),F.on(o,function(t){var e;return e=y(t,F,A,E,C),_(e,F,A,E,C),!1}))},e=function(){function e(e){this.doAction=__bind(this.doAction,this);var n,s,i;this.id=null!=(n=e.id)?(""+n).toLowerCase():void 0,this.isFantom=e.isFantom||!1,this.number=(null!=(s=e.number)?""+s:void 0)||"",this.numberFormatted=(null!=(i=e.numberFormatted)?""+i:void 0)||this.number,this.numberHtml=d(this.numberFormatted),this.name=e.name,this.nameHtml=e.name?d(e.name):this.numberHtml,this.state=!1,this.avatarLink32x32=e.avatarLink32x32||this.defaultAvatar32||"",this.defaultAvatarCss=this.avatarLink32x32?"":"m_default",this.hasHover=!1,this.buttonLastAction="",this.firstLiCssPrefix="m_button_action_",this.els=t(),this.buttonEls=t(),this.init(e)}return e.prototype.init=function(t){var e,n,s,i;return this.id=null!=(e=t.id)?(""+e).toLowerCase():void 0,this.isFantom=t.isFantom||!1,this.number=(null!=(n=t.number)?""+n:void 0)||"",this.numberFormatted=(null!=(s=t.numberFormatted)?""+s:void 0)||this.number,this.numberHtml=d(this.numberFormatted),this.name=t.name,this.nameHtml=t.name&&""+t.name!==this.number?d(t.name):this.numberHtml,this.avatarLink32x32=t.avatarLink32x32||this.defaultAvatar32||"",this.defaultAvatarCss=this.avatarLink32x32?"":"m_default",this.loadActions(),null!=(null!=(i=t.numberObj)?i.state:void 0)?this.setState(t.numberObj.state):null!=t.state?this.setState(t.state):this.setState(1)},e.prototype.regexps={name:/\{\{name\}\}/,number:/\{\{number\}\}/,avatarLink32x32:/\{\{avatarLink32x32\}\}/,css:/\{\{css\}\}/},e.prototype.setState=function(t){var e=this;return t=parseInt(t),t!==this.state?(this.state=t,this.setStateCss(),this.buttonEls.length?(this.loadActions(),setTimeout(function(){return e.loadActions()},100)):void 0):void 0},e.prototype.setStateCss=function(){return this.els.length?0===this.state?this.els.removeClass("m_busy").addClass("m_offline"):5===this.state?this.els.removeClass("m_offline").addClass("m_busy"):this.els.removeClass("m_offline").removeClass("m_busy"):void 0},e.prototype.getInfo=function(){return'"'+this.number+'" '+this.state+" "+this.name},e.prototype.isFiltered=function(t){return t&&"string"==typeof t?this.number&&-1!==this.number.indexOf(t)||-1!==(" "+this.name).toLowerCase().indexOf(t)?!0:!1:!0},e.prototype.getEl=function(){var e,n,s=this;return n=this.template.replace(this.regexps.name,this.nameHtml).replace(this.regexps.number,this.numberHtml!==this.nameHtml?this.numberHtml:"").replace(this.regexps.avatarLink32x32,this.avatarLink32x32).replace(this.regexps.css,this.defaultAvatarCss),e=t(n),this.els=this.els.add(e),this.setStateCss(),e.data("user",this),e.bind("mouseenter",function(){return s.isHovered(!0)}),e.bind("mouseleave",function(){return s.isHovered(!1)}),this.initButtonEl(e.find(".oktell_button_action")),e},e.prototype.initButtonEl=function(t){var e=this;return this.buttonEls=this.buttonEls.add(t),t.data("user",this),t.children(":first").bind("click",function(){return e.doAction(e.buttonLastAction)}),this.buttonLastAction?t.addClass(this.firstLiCssPrefix+this.buttonLastAction.toLowerCase()):void 0},e.prototype.getButtonEl=function(){var e;return e=t(this.buttonTemplate),this.initButtonEl(e),e},e.prototype.isHovered=function(t){return this.hasHover!==t?(this.hasHover=t,this.hasHover?this.loadActions():void 0):void 0},e.prototype.loadOktellActions=function(){var t;return t=this.oktell.getPhoneActions(this.id||this.number)},e.prototype.loadActions=function(){var t,e;return e=this.loadOktellActions(),t=(null!=e?e[0]:void 0)||"",this.buttonLastAction===t?e:(this.buttonLastAction&&this.buttonEls.removeClass(this.firstLiCssPrefix+this.buttonLastAction.toLowerCase()),t?(this.buttonLastAction=t,this.buttonEls.addClass(this.firstLiCssPrefix+this.buttonLastAction.toLowerCase())):this.buttonLastAction="",e)},e.prototype.doAction=function(t){var e;if(t)switch(e=this.number,t){case"call":return this.oktell.call(e);case"conference":return this.oktell.conference(e);case"intercom":return this.oktell.intercom(e);case"transfer":return this.oktell.transfer(e);case"toggle":return this.oktell.toggle();case"ghostListen":return this.oktell.ghostListen(e);case"ghostHelp":return this.oktell.ghostHelp(e);case"ghostConference":return this.oktell.ghostConference(e);case"endCall":return this.oktell.endCall(e)}},e.prototype.doLastFirstAction=function(){return this.buttonLastAction?(this.doAction(this.buttonLastAction),!0):!1},e}(),n=function(){function n(n,s,i,o,r){var l,a,c,d,h=this;this.allActions={call:{icon:"/img/icons/action/call.png",iconWhite:"/img/icons/action/white/call.png",text:this.langs.call},conference:{icon:"/img/icons/action/confinvite.png",iconWhite:"/img/icons/action/white/confinvite.png",text:this.langs.conference},transfer:{icon:"/img/icons/action/transfer.png",text:this.langs.transfer},toggle:{icon:"/img/icons/action/toggle.png",text:this.langs.toggle},intercom:{icon:"/img/icons/action/intercom.png",text:this.langs.intercom},endCall:{icon:"/img/icons/action/endcall.png",iconWhite:"/img/icons/action/white/endcall.png",text:this.langs.endCall},ghostListen:{icon:"/img/icons/action/ghost_monitor.png",text:this.langs.ghostListen},ghostHelp:{icon:"/img/icons/action/ghost_help.png",text:this.langs.ghostHelp}},this.actionCssPrefix="i_",this.lastDropdownUser=!1,this.filterFantomUserNumber=!1,this.userWithGeneratedButtons={},this.debugMode=r,this.dropdownPaddingBottomLeft=3,this.dropdownOpenedOnPanel=!1,this.regexps={actionText:/\{\{actionText\}\}/,action:/\{\{action\}\}/,css:/\{\{css\}\}/},d=!1,this.usersByNumber={},this.me=!1,this.oktell=n,this.panelUsers=[],this.panelUsersFiltered=[],this.abonents={},this.hold={},this.queue={},this.oktell=n,e.prototype.oktell=n,this.filter=!1,this.panelEl=s,this.dropdownEl=i,this.dropdownElLiTemplate=this.dropdownEl.html(),this.dropdownEl.empty(),this.keypadEl=this.panelEl.find(".j_phone_keypad"),this.keypadIsVisible=!1,this.usersListBlockEl=this.panelEl.find(".j_main_list"),this.usersListEl=this.usersListBlockEl.find("tbody"),this.abonentsListBlock=this.panelEl.find(".j_abonents"),this.abonentsListEl=this.abonentsListBlock.find("tbody"),this.talkTimeEl=this.abonentsListBlock.find(".b_marks_time"),this.holdBlockEl=this.panelEl.find(".j_hold"),this.holdListEl=this.holdBlockEl.find("tbody"),this.queueBlockEl=this.panelEl.find(".j_queue"),this.queueListEl=this.queueBlockEl.find("tbody"),this.filterInput=this.panelEl.find("input"),this.filterClearCross=this.panelEl.find(".jInputClear_close"),l=!1,this.usersWithBeforeConnectButtons=[],this.jScroll(this.usersListBlockEl),this.usersScroller=this.usersListBlockEl.find(".jscroll_scroller"),this.userScrollerToTop=function(){return h.usersScroller.css({top:"0px"})},this.filterClearCross.bind("click",function(){return h.clearFilter()}),this.filterInput.bind("keyup",function(t){return h.oktellConnected?(l||(l=u(function(){return h.setFilter((""+h.filterInput.val()).toLowerCase())},100)),h.filterInput.val()?h.filterClearCross.show():h.filterClearCross.hide(),13===t.keyCode?(h.filterInput.blur(),setTimeout(function(){var t;return t=h.panelUsersFiltered[0],t.doLastFirstAction(),h.clearFilter()},50)):l(),!0):!0}),this.panelEl.bind("click",function(e){var n,s,i;return s=t(e.target),s.is(".b_contact .drop_down")||0!==s.closest(".b_contact .drop_down").size()?(n=s.closest(".oktell_button_action"),0===n.size()?!0:(i=n.data("user"),i?h.showDropdown(i,n,i.loadOktellActions(),!0):void 0)):!0}),this.dropdownEl.bind("click",function(e){var n,s,i,o;if(i=t(e.target),i.is("[data-action]"))s=i;else{if(0===i.closest("[data-action]").size())return!0;s=i.closest("[data-action]")}return(n=s.data("action"))?(o=h.dropdownEl.data("user"),n&&o&&o.doAction(n),h.dropdownEl.hide()):void 0}),c="",this.dropdownEl.hover(function(){return clearTimeout(c)},function(){return c=setTimeout(function(){return h.dropdownEl.fadeOut(150,function(){return h.dropdownOpenedOnPanel=!1})},500)}),this.panelEl.find(".j_keypad_expand").bind("click",function(){return h.toggleKeypadVisibility(),h.filterInput.focus()}),this.keypadEl.find("li").bind("click",function(e){return h.filterInput.focus(),h.filterInput.val(h.filterInput.val()+t(e.currentTarget).find("button").data("num")),h.filterInput.keyup()}),this.setUserListHeight=function(){return h.usersListBlockEl.css({height:t(window).height()-h.usersListBlockEl[0].offsetTop+"px"})},this.setUserListHeight(),a=u(function(){return h.userScrollerToTop(),h.setUserListHeight()},50),t(window).bind("resize",function(){return a()}),n.on("disconnect",function(){var t,e,n,s;h.oktellConnected=!1,h.usersByNumber={},h.panelUsers=[],h.setPanelUsersHtml([]),h.setAbonents([]),h.setHold({hasHold:!1}),h.filterInput.val(""),h.setFilter("",!0),h.setQueue([]),n=h.userWithGeneratedButtons,s=[];for(t in n)e=n[t],s.push(e.loadActions());return s}),n.on("connect",function(){var t,s,i,r,l,a,u,c,d,p,f;h.oktellConnected=!0,s=n.getMyInfo(),s.userid=(""+s.userid).toLowerCase(),h.myNumber=null!=(d=s.number)?""+d:void 0,e.prototype.defaultAvatar=s.defaultAvatar,e.prototype.defaultAvatar32=s.defaultAvatar32x32,e.prototype.defaultAvatar64=s.defaultAvatar64x64,r=n.getUsers();for(t in r)__hasProp.call(r,t)&&(i=r[t],l=(null!=(p=i.number)?""+p:void 0)||"",h.usersByNumber[l]?(a=h.usersByNumber[l],i.isFantom=!1,a.init(i)):(a=new e(i),a.number&&(h.usersByNumber[a.number]=a)),a.id!==s.userid?h.panelUsers.push(a):h.me=a);for(h.sortPanelUsers(h.panelUsers),n.on("stateChange",function(){return h.reloadActions()}),n.onNativeEvent("pbxnumberstatechanged",function(t){var e,n,s,i,o,r,l;for(o=t.numbers,l=[],s=0,i=o.length;i>s;s++)e=o[s],n=""+e.num,l.push(null!=(r=h.usersByNumber[n])?r.setState(e.numstateid):void 0);return l}),n.on("abonentsChange",function(t){return h.setAbonents(t),h.reloadActions()}),n.on("holdStateChange",function(t){return h.setHold(t),h.reloadActions()}),n.on("talkTimer",function(t,e){return t===!1?h.talkTimeEl.text(""):h.talkTimeEl.text(e)}),h.setAbonents(n.getAbonents()),h.setHold(n.getHoldInfo()),h.setFilter("",!0),n.on("queueChange",function(t){return h.setQueue(t)}),n.getQueue(function(t){return t.result?h.setQueue(t.queue):void 0}),f=h.usersWithBeforeConnectButtons,u=0,c=f.length;c>u;u++)a=f[u],a.loadActions();return"function"==typeof o?o():void 0})}return n.prototype.getUserButtonForPlugin=function(t){var e,n,s=this;return n=this.getUser(t),this.oktellConnected||this.usersWithBeforeConnectButtons.push(n),this.userWithGeneratedButtons[t]=n,e=n.getButtonEl(),e.find(".drop_down").bind("click",function(){var t;return t=n.loadActions(),s.showDropdown(n,e,t)}),e},n.prototype.clearFilter=function(){return this.filterInput.val(""),this.setFilter(""),this.filterInput.keyup()},n.prototype.toggleKeypadVisibility=function(){return this.setKeypadVisibility(!this.keypadIsVisible)},n.prototype.setKeypadVisibility=function(t){return null!=t&&Boolean(this.keypadIsVisible)!==Boolean(t)?(this.keypadIsVisible=Boolean(t),this.keypadEl.stop(!0,!0),this.keypadIsVisible?this.keypadEl.slideDown(200,this.setUserListHeight):this.keypadEl.slideUp(200,this.setUserListHeight)):void 0},n.prototype.addEventListenersForButton=function(e,n){var s=this;return n.bind("click",function(){return e?s.showDropdown(e,t(s)):void 0})},n.prototype.showDropdown=function(e,n,s,i){var o,r,l,a,u,c;if(l=this.dropdownElLiTemplate,this.dropdownEl.empty(),null!=s?!s.length:true)return this.dropdownEl.hide();for(r=[],a=0,u=s.length;u>a;a++)o=s[a],"string"==typeof o&&(null!=(c=this.allActions[o])?c.text:void 0)&&r.push(l.replace(this.regexps.actionText,this.allActions[o].text).replace(this.regexps.action,o).replace(this.regexps.css,this.actionCssPrefix+o.toLowerCase()));return r.length?(this.dropdownEl.append(r),this.dropdownEl.children("li:first").addClass("g_first"),this.dropdownEl.children("li:last").addClass("g_last"),this.dropdownEl.data("user",e),this.dropdownEl.css({top:this.dropdownEl.height()+n.offset().top>t(window).height()?t(window).height()-this.dropdownEl.height()-this.dropdownPaddingBottomLeft:n.offset().top,left:Math.max(this.dropdownPaddingBottomLeft,n.offset().left-this.dropdownEl.width()+n.width()),visibility:"visible"}),this.dropdownEl.fadeIn(100),i?this.dropdownOpenedOnPanel=!0:void 0):this.dropdownEl.hide()},n.prototype.logUsers=function(){var t,e,n,s;n=this.panelUsersFiltered,s=[];for(t in n)__hasProp.call(n,t)&&(e=n[t],s.push(this.log(e.getInfo())));return s},n.prototype.syncAbonentsAndUserlist=function(e,n){var s,i,o,r,l=this;s={},t.each(e,function(t,e){var i,o;if(e&&(i=""+e.phone||""))return s[i]=e,n[""+e.phone]?void 0:(o=l.getUser({name:e.name,number:e.phone,id:e.userid,state:1}),n[o.number]=o)}),r=[];for(i in n)__hasProp.call(n,i)&&(o=n[i],s[o.number]?r.push(void 0):r.push(delete n[o.number]));return r},n.prototype.setAbonents=function(t){return this.syncAbonentsAndUserlist(t,this.abonents),this.setAbonentsHtml()},n.prototype.setQueue=function(t){var e,n,s,i,o,r;if("ring"===this.oktell.getState())for(n=i=0,o=t.length;o>i;n=++i)e=t[n],this.abonents[e.phone]&&delete t[n];this.syncAbonentsAndUserlist(t,this.queue),r=this.queue;for(n in r)__hasProp.call(r,n)&&(s=r[n],s.loadActions());return this.setQueueHtml()},n.prototype.setHold=function(t){var e;return e=[],t.hasHold&&(e=[t.abonent]),this.syncAbonentsAndUserlist(e,this.hold),this.setHoldHtml()},n.prototype.setPanelUsersHtml=function(t){return this._setUsersHtml(t,this.usersListEl),this.userScrollerToTop()},n.prototype.setAbonentsHtml=function(){return this._setActivityPanelUserHtml(this.abonents,this.abonentsListEl,this.abonentsListBlock)},n.prototype.setHoldHtml=function(){return this._setActivityPanelUserHtml(this.hold,this.holdListEl,this.holdBlockEl)},n.prototype.setQueueHtml=function(){return this._setActivityPanelUserHtml(this.queue,this.queueListEl,this.queueBlockEl)},n.prototype._setActivityPanelUserHtml=function(t,e,n){var s,i,o;o=[];for(s in t)__hasProp.call(t,s)&&(i=t[s],o.push(i));return this._setUsersHtml(o,e),o.length&&n.is(":not(:visible)")?n.slideDown(200,this.setUserListHeight):0===o.length&&n.is(":visible")?n.slideUp(200,this.setUserListHeight):void 0},n.prototype._setUsersHtml=function(t,e){var n,s,i,o;for(n=[],i=0,o=t.length;o>i;i++)s=t[i],n.push(s.getEl());return e.html(n)},n.prototype.sortPanelUsers=function(t){return t.sort(function(t,e){return t.number&&!e.number?-1:!t.number&&e.number?1:t.state&&!e.state?-1:!t.state&&e.state?1:t.name>e.name?1:t.name<e.name?-1:void 0})},n.prototype.setFilter=function(t,e){var n,s,i,o,r,l,a,u;if(this.filter===t&&!e)return!1;if(o=this.filter,this.filter=t,""===t)return this.panelUsersFiltered=[].concat(this.panelUsers),this.afterSetFilter(this.panelUsersFiltered),this.panelUsersFiltered;for(s=[],n=!1,i=0===o.indexOf(this.filter)?this.panelUsersFiltered:this.panelUsers,u=this.panelUsers,l=0,a=u.length;a>l;l++)r=u[l],r.isFiltered(t)&&(s.push(r),r.number!==t||n||(n=r));return n?this.panelUsersFiltered=s:(this.filterFantomUser=this.getUser({name:t,number:t},!0),this.panelUsersFiltered=[this.filterFantomUser].concat(s)),this.afterSetFilter(this.panelUsersFiltered),this.panelUsersFiltered},n.prototype.afterSetFilter=function(t){return this.setPanelUsersHtml(t)},n.prototype.getUser=function(t,n){var s,i,o,r;return"string"==typeof t||"number"==typeof t?(o=""+t,t={number:o}):o=""+t.number,i=t.phoneFormatted||("function"==typeof C.formatPhone?C.formatPhone(o):void 0)||o,t.numberFormatted||(t.numberFormatted=i),n||(null!=(r=this.filterFantomUser)?r.number:void 0)!==o||(this.usersByNumber[o]=this.filterFantomUser,t.isFantom=!0,this.filterFantomUser=!1),this.usersByNumber[o]?(this.usersByNumber[o].isFantom&&this.usersByNumber[o].init(t),this.usersByNumber[o]):(s=new e({number:o,numberFormatted:i,name:t.name,isFantom:!0,state:null!=(null!=t?t.state:void 0)?t.state:1}),n||(this.usersByNumber[o]=s),s)},n.prototype.reloadActions=function(){var t=this;return setTimeout(function(){var e,n,s,i,o,r,l,a;i=t.userWithGeneratedButtons;for(n in i)__hasProp.call(i,n)&&(s=i[n],e=s.loadActions());o=t.abonents;for(n in o)s=o[n],s.loadActions();r=t.queue;for(n in r)s=r[n],s.loadActions();l=t.panelUsersFiltered,a=[];for(n in l)s=l[n],a.push(s.loadActions());return a},100)},n}(),s=function(){function e(t,e){var n=this;this.el=t,this.absContainer=this.el.find(".b_content"),this.abonentEl=this.absContainer.find(".b_abonent").remove(),this.answerActive=!1,this.answerButttonEl=this.el.find(".j_answer"),this.puckupEl=this.el.find(".j_pickup"),this.el.find(".j_abort_action").bind("click",function(){return n.hide(),e.endCall()}),this.el.find(".j_answer").bind("click",function(){return n.hide(),e.answer()}),this.el.find(".j_close_action").bind("click",function(){return n.hide()}),this.el.find("i.o_close").bind("click",function(){return n.hide()}),e.on("phoneRegistered",function(){return n.answerButtonVisible(!0)}),e.on("phoneUnregistered",function(){return n.answerButtonVisible(!1)}),e.on("phoneRingStart",function(t){return n.log("OKTELL phoneRingStart",t),n.setAbonents(t),n.show()}),e.on("phoneCallStart",function(t){return n.log("OKTELL phoneCallStart",t),n.hide()}),e.on("phoneTalkStart",function(t){return n.log("OKTELL phoneTalkStart",t),n.hide()}),e.on("phoneSessionStop",function(t){return n.log("OKTELL phoneSessionStop",t),n.hide()}),e.on("ringStart",function(t){return n.answerActive?void 0:(n.setAbonents(t),n.show())}),e.on("ringStop",function(){return n.answerActive?void 0:n.hide()})}return e.prototype.show=function(t){return this.log("Popup show! ",t),this.el.fadeIn(200)},e.prototype.hide=function(){return this.el.fadeOut(200)},e.prototype.setAbonents=function(e){var n=this;return this.absContainer.empty(),t.each(e,function(t,e){var s,i,o;return o=""+e.phone,i=""+e.name||o,i===o&&(o=""),s=n.abonentEl.clone(),s.find("span:first").text(i),s.find("span:last").text(o),n.absContainer.append(s)})},e.prototype.answerButtonVisible=function(t){return t?(this.answerActive=!0,this.answerButttonEl.show(),this.puckupEl.hide()):(this.answerActive=!1,this.answerButttonEl.hide(),this.puckupEl.show())},e.prototype.setCallbacks=function(t,e){return this.onAnswer=t,this.onTerminate=e},e}(),c={position:"right",dynamic:!1,oktell:window.oktell,debug:!1,lang:"ru",jsSIPUA:!1},_={ru:{panel:{inTalk:"В разговоре",onHold:"На удержании",queue:"Очередь ожидания",inputPlaceholder:"введите имя или номер"},actions:{call:"Позвонить",conference:"Конференция",transfer:"Перевести",toggle:"Переключиться",intercom:"Интерком",endCall:"Завершить",ghostListen:"Прослушка",ghostHelp:"Помощь"}},en:{panel:{inTalk:"In conversation",onHold:"On hold",queue:"Wait queue",inputPlaceholder:"Enter name or number"},actions:{call:"Dial",conference:"Conference",transfer:"Transfer",toggle:"Switch",intercom:"Intercom",endCall:"End",ghostListen:"Audition",ghostHelp:"Help"}},cz:{panel:{inTalk:"V rozhovoru",onHold:"Na hold",queue:"Fronta čekaní",inputPlaceholder:"zadejte jméno nebo číslo"},actions:{call:"Zavolat",conference:"Konference",transfer:"Převést",toggle:"Přepnout",intercom:"Intercom",endCall:"Ukončit",ghostListen:"Odposlech",ghostHelp:"Nápověda"}}},x=null,o=null,C=null,A=!1,a=null,y=null,B=null,v=null,h=function(){return x||c},E="",k=function(){var t,e,n,s,i,o,r,l;for(h().debug||enerated(buttonreturn),e=new Date,n=e.getFullYear()+"-"+(10>e.getMonth()?"0":"")+e.getMonth()+"-"+(10>e.getDate()?"0":"")+e.getDate(),i=(10>e.getHours()?"0":"")+e.getHours()+":"+(10>e.getMinutes()?"0":"")+e.getMinutes()+":"+(10>e.getSeconds()?"0":"")+e.getSeconds()+":"+(""+(e.getMilliseconds()+1e3)).substr(1),E+=n+" "+i+" | ",t=["Oktell-Panel "+i+" |"],r=0,l=arguments.length;l>r;r++){if(o=arguments[r],"object"==typeof o)try{E+=JSON.stringify(o)}catch(a){s=a,E+=""+o}else E+=o;E+=" | ",t.push(o)}E+="\n\n";try{return console.log.apply(console,t||[])}catch(a){s=a}},P={"templates/actionButton.html":'<ul class="oktell_button_action"><li class="g_first"><i></i></li><li class="g_last drop_down"><i></i></li></ul>',"templates/actionList.html":'<ul class="oktell_actions_group_list"><li class="{{css}}" data-action="{{action}}"><i></i><span>{{actionText}}</span></li></ul>',"templates/user.html":'<tr class="b_contact"><td class="b_contact_avatar {{css}}"><img src="{{avatarLink32x32}}"><i></i><div class="o_busy"></div></td><td class="b_contact_title"><div class="wrapword"><a><b>{{name}}</b><span class="o_number">{{number}}</span></a></div>{{button}}</td></tr>',"templates/panel.html":'<div class="oktell_panel"><div class="i_panel_bookmark"><div class="i_panel_bookmark_bg"></div></div><div class="h_panel_bg"><div class="h_padding"><div class="b_marks i_conference j_abonents"><div class="b_marks_noise"><p class="b_marks_header"><span class="b_marks_label">{{inTalk}}</span><span class="b_marks_time"></span></p><table><tbody></tbody></table></div></div><div class="b_marks i_flash j_hold"><div class="b_marks_noise"><p class="b_marks_header"><span class="b_marks_label">{{onHold}}</span></p><table class="j_table_favorite"><tbody></tbody></table></div></div><div class="b_marks i_flash j_queue"><div class="b_marks_noise"><p class="b_marks_header"><span class="b_marks_label">{{queue}}</span></p><table class="j_table_queue"><tbody></tbody></table></div></div><div class="b_inconversation j_phone_block"><table class="j_table_phone"><tbody></tbody></table></div><div class="b_marks i_phone"><div class="h_shadow_bottom"><div class="h_phone_number_input"><div class="i_phone_state_bg"></div><div class="h_input_padding"><div class="i_phone_popup_button j_keypad_expand"><i></i></div><div class="jInputClear_hover"><input class="b_phone_number_input" type="text" placeholder="{{inputPlaceholder}}"><span class="jInputClear_close">&times;</span></div></div><div class="b_phone_keypad j_phone_keypad"><div class="l_column_group"><div class="h_phone_keypad"><ul class="b_phone_panel"><li class="g_top_left g_first"><button data-num="1" class="g_button m_big">1</button></li><li><button data-num="2" class="g_button m_big">2</button></li><li class="g_top_right g_right"><button data-num="3" class="g_button m_big">3</button></li><li class="g_float_celar g_first"><button data-num="4" class="g_button m_big">4</button></li><li><button data-num="5" class="g_button m_big">5</button></li><li class="g_right"><button data-num="6" class="g_button m_big">6</button></li><li class="g_float_celar g_first"><button data-num="7" class="g_button m_big">7</button></li><li><button data-num="8" class="g_button m_big">8</button></li><li class="g_right"><button data-num="9" class="g_button m_big">9</button></li><li class="g_bottom_left g_float_celar g_first"><button data-num="*" class="g_button m_big">&lowast;</button></li><li class="g_bottom_center"><button data-num="0" class="g_button m_big">0</button></li><li class="g_bottom_right g_right"><button data-num="#" class="g_button m_big">#</button></li></ul></div></div></div></div></div></div><div class="h_main_list j_main_list"><table class="b_main_list"><tbody></tbody></table></div></div></div></div>',"templates/callPopup.html":'<div class="oktell_panel_popup" style="display: none"><div class="m_popup_staff"><div class="m_popup_data"><header><div class="h_header_bg"><i class="o_close"></i><h2>Входящий вызов</h2></div></header><div class="b_content"><div class="b_abonent"><span data-bind="text: name"></span>&nbsp;<span class="g_light" data-bind="textPhone: number"></span></div></div><div class="footer"><div class="b_take_phone j_pickup"><i></i>&nbsp;<span>Поднимите трубку</span></div><button class="oktell_panel_btn m_big m_button_green j_answer" style="margin-right: 20px; float: left"><i style="background: url(\'/img/icons/action/white/call.png\') no-repeat; vertical-align: -2px"></i>ответить</button><button class="oktell_panel_btn m_big j_close_action">Скрыть</button><button class="oktell_panel_btn m_big m_button_red j_abort_action"><i></i>Отклонить</button></div></div></div></div>'},w=function(e){var n;return"/"===e[0]&&(e=e.substr(1)),null!=P[e]?P[e]:(n="",t.ajax({url:e,async:!1,success:function(t){return n=t}}),n)},i=w("/templates/actionButton.html"),r=w("/templates/actionList.html"),j=w("/templates/user.html"),H=w("/templates/panel.html"),F=w("/templates/callPopup.html"),n.prototype.jScroll=g,e.prototype.buttonTemplate=i,e.prototype.log=k,n.prototype.log=k,s.prototype.log=k,U=!1,L=function(t){var e;return k("onJsSIPNewSession ",t),"remote"===(null!=t?null!=(e=t.data)?e.originator:void 0:void 0)&&null!=B?(B.answerButtonVisible(!0),B.setCallbacks(function(){return t.data.session.answer()},function(){return t.data.session.terminate()}),B.show()):void 0},b=function(t){return v&&v.off("newSession",L),t?(v=t,v.on("newSession",L)):void 0},m=function(l){var u,d,p,f,m,g,v,w,k,E,A,L,P,S,T,I,O,q,M,N,V,D,z,W,K,Q,G;return U=!0,x=t.extend(c,l||{}),_=_[x.lang]||_.ru,e.prototype.template=j.replace("{{button}}",i),H=H.replace("{{inTalk}}",_.panel.inTalk).replace("{{onHold}}",_.panel.onHold).replace("{{queue}}",_.panel.queue).replace("{{inputPlaceholder}}",_.panel.inputPlaceholder),n.prototype.langs=_.actions,N=t(H),W=t(F),t("body").append(W),u=t(j),d=t(i),O=d.attr("data-bind"),d.attr("data-bind",O+", visible: $data.actionBarIsVisible"),u.find("td.b_contact_title").append(d),o=t(r),t("body").append(o),C=h().oktell,B=new s(W,C),D=h().position,f={},f[D]="0px",p={},p[D]="-281px",t("body").append(N),y=new n(C,N,o,a,h().debug),h().debug&&(window.wList=y,window.wPopup=B),"right"===D?N.addClass("right"):"left"===D&&N.addClass("left"),h().dynamic&&N.addClass("dynamic"),M=N.find(".i_panel_bookmark"),g={},v="left"===D?"right":"left",g[v]="0px",m={},m[v]="-40px",T=!1,V=!1,z="closed",S=function(){return clearTimeout(V),V=!1},N.on("mouseenter",function(){return T=!0,S(),0>parseInt(N.css(D))&&("closed"===z||"closing"===z)&&(z="opening",M.stop(!0,!0),M.animate(g,50,"swing"),N.stop(!0,!0),N.animate(f,100,"swing",function(){return N.addClass("g_hover"),z="open"})),!0}),P=function(){return N.hasClass("g_hover")?(z="closing",N.stop(!0,!0),N.animate(p,300,"swing",function(){return N.css({panelPos:0}),N.removeClass("g_hover"),z="closed"}),setTimeout(function(){return M.animate(m,50,"swing")},150)):void 0},N.on("mouseleave",function(){return T=!1,!0}),t("html").bind("mouseleave",function(){return S(),!0}),t("html").bind("mousemove",function(){return T||V!==!1||y.dropdownOpenedOnPanel||(V=setTimeout(function(){return P()},100)),!0}),-1!==window.navigator.userAgent.indexOf("iPad")&&(G=0,Q=0,A=N,L=0,k=0,E=-281,K=0,I=0,q="j_open",w="j_close",0>parseInt(A[0].style.right)&&A.addClass(w),A.live("click",function(){return A.hasClass(w)?A.animate(f,200,"swing",function(){return A.removeClass(w).addClass(q),K=0}):void 0}),A.live("touchstart",function(t){return G=t.originalEvent.touches[0].pageX,L=A.width(),k=13*(L/100),E=parseInt(A.css(D))}),A.bind("touchmove",function(t){return t.preventDefault(),Q=t.originalEvent.touches[0].pageX,K=Q-G,I=E-K,-281>I?I=-281:I>0&&(I=0),A[0].style.right=I+"px"}),A.bind("touchend",function(){return K>=k&&0>K?A.animate(p,200,"swing"):void 0}),-1*K>=k&&K>0&&A.animate(f,200,"swing"),k>K&&0>K&&A.animate(f,100,"swing",function(){return A.removeClass(w).addClass(q)}),k>-1*K&&K>0&&A.animate(p,100,"swing",function(){return A.removeClass(q).addClass(w)})),b(h().jsSIPUA)},a=function(){return A=!0},f=function(t){var e,n;return t.addClass(h().buttonCss),n=t.attr("data-phone"),n?(e=y.getUserButtonForPlugin(n),k("generated button for "+n,e),t.html(e)):void 0},l=function(t){return f(t)},p=function(e){return t(e+":not(."+actionButtonContainerClass+")").each(function(){return l(t(this))})},t.oktellPanel=function(t){if("string"==typeof t){if(U&&p(t),null!=t?t.jsSIPUA:void 0)return b(t.jsSIPUA)
}else if(!U)return m(t)},t.fn.oktellButton=function(){return t(this).each(function(){return l(t(this))})}})($);
=======
var __indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},__bind=function(t,e){return function(){return t.apply(e,arguments)}},__slice=[].slice,__hasProp={}.hasOwnProperty;(function(t){var e,n,s,i,o,r,l,a,u,h,c,d,p,f,m,g,b,_,v,y,w,k,C,E,x,U,L,O,A,P,H,I,B,S,F,j,T;if(!t)throw new s("Error init oktell panel, jQuery ( $ ) is not defined");return d=function(t,e,n){var s;return s="",function(){var i,o,r,l,a;return r=this,i=arguments,l=function(){var e;return s=null,n?void 0:e=t.apply(r,i)},o=n&&!s,clearTimeout(s),s=setTimeout(l,e),o&&(a=t.apply(r,i)),a}},b=function(t){return(""+t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},U=function(){var t;try{return console.log.apply(console,arguments)}catch(e){t=e}},c=function(e,n,s){var i,o,r,l;return arguments.length>1&&"[object Object]"!=n+""?(s=t.extend({},s),null==n&&(s.expires=-1),"number"==typeof s.expires&&(r=s.expires,l=s.expires=new Date,l.setSeconds(l.getSeconds()+r)),n+="",document.cookie=[encodeURIComponent(e),"=",s.raw?n:encodeURIComponent(n),s.expires?"; expires="+s.expires.toUTCString():"",s.path?"; path="+s.path:"",s.domain?"; domain="+s.domain:"",s.secure?"; secure":""].join("")):(s=n||{},o="",i=s.raw?function(t){return t}:decodeURIComponent,(o=RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie))?i(o[1]):null)},k=function(e){var n,s,i,o,r,l,a,u,h,c,d,p,f,m,g,b,_,v,y,w,k,C,E,x,U,L,O,A,P,H;return H="",x="",C="",E="",U="",d="",p="",f="",g="",b="",L="",m={},y=function(t,e,n){var s;return t=t.originalEvent,s=t.detail?-14*t.detail:t.wheelDelta/3,b=a(n),p=l(t),(b>=0&&s>0||b+s>0)&&(s=0,b=0),(e.height()-n.height()>=b&&0>s||e.height()-n.height()>b+s)&&(b=e.height()-n.height(),s=0),g=b+s},_=function(e,o,u,c,_){var y,C;if(e.type===i){if(m.noMoveMouse)return;return f=l(e),b=a(u),L=!0,t("body").css({"-moz-user-select":"none","-ms-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-webkit-touch-callout":"none","user-select":"none"})}if(e.type===s){if(!L)return;return h&&k(_),y=r(o,u),p=l(e),d?(g=b*y-(p-f),g/=y):g=b+(p-f),g>=0&&(b=a(u),f=p,g=0),C=o.height()-u.height(),C>=g&&(b=a(u),f=p,g=C),v(g,o,u,c,_),m.noMoveMouse=!0}if(e.type===n){if(!L)return;if(L=!1,d=!1,h&&w(_),t("body").css({"-moz-user-select":"","-ms-user-select":"","-khtml-user-select":"","-webkit-user-select":"","-webkit-touch-callout":"","user-select":""}),U)return w(_)}},v=function(t,e,n,s,i){return k(i),A(n,t),O(e,n,s,i)},l=function(t){return h?t.originalEvent.targetTouches[0].clientY:t.clientY},A=function(t,e){return t.css({position:"relative",top:e})},a=function(t){var e;return e=t.css("top"),"auto"===e&&(e=0),parseInt(e)},r=function(t,e){var n,s,i;return i=t.height(),s=e.height(),n=i/s},k=function(t){return t.stop(!0,!0),t.fadeIn(100)},w=function(t){return t.stop(!0,!0),t.fadeOut("slow")},O=function(t,e,n,s){var i,o,l,u,h,c,d,p;return i=n.height(),l=r(t,e),o=i*l,d=l>=1?"hidden":"visible",s.css({height:o,visibility:d}),c=a(e),p=t.height(),h=e.height(),0>=c&&p-h>=c&&(g=p-h,g=Math.min(g,0),A(e,g)),u=c/p,g=p*u,A(s,-1*g*l),null!=m?"function"==typeof m.onScroll?m.onScroll({wrapper:t,scroller:e,position:c,length:h}):void 0:void 0},L=!1,d=!1,P=/webkit/i.test(navigator.appVersion)?"webkit":/firefox/i.test(navigator.userAgent)?"Moz":__indexOf.call(window,"opera")>=0?"O":"",h=window.ontouchstart!==void 0,i=h?"touchstart":"mousedown",s=h?"touchmove":"mousemove",n=h?"touchend":"mouseup",o="Moz"===P?"DOMMouseScroll":"mousewheel",!h&&t(".jscroll_wrapper",e).size()||(u=function(){var n,s,i;return e.wrapInner('<div class="jscroll_wrapper" />'),H=t(".jscroll_wrapper",e),H.attr("id","jscroll_id"+Math.round(1e7*Math.random())),x=H.wrapInner('<div class="jscroll_scroller" />'),x=t(".jscroll_scroller",H),C=t('<div class="jscroll_scrollbar_cont"></div>').insertAfter(x),C.css({position:"absolute",right:"0px",width:"13px",top:"3px",bottom:"6px"}),E=t('<div class="jscroll_scrollbar_inner"></div>').appendTo(C),E.css({position:"relative",width:"100%",display:"none",opacity:"0.4",cursor:"pointer"}),s=t('<div class="jscroll_scrollbar_bar"></div>').appendTo(E),s.css({position:"relative",background:"black",width:"5px",margin:"0 auto","border-radius":"3px",height:"100%","-webkit-border-radius":"3px"}),H.css({position:"relative",height:"100%",overflow:"hidden"}),x.css({"min-height":"100%",overflow:"hidden"}),h?(x.after('<div class="jscroll_scroller_inner" />'),i=t(".jscroll_scroller_inner",H),i.appendTo("<div></div>"),null!=window.iScroll&&(n=new window.iScroll(H.attr("id"),{hScrollbar:!1,scrollbarClass:"jscroll_scroller_inner",checkDOMChanges:!0,bounceLock:!0,onScrollMove:function(){return m.onScroll(),!0},onScrollEnd:function(){return m.onScroll(),!0}})),!0):O(H,x,C,E)},u(),h)?void 0:(c=[],H.bind("resize",function(){var t;t=H.attr("id"),c[t]!==void 0&&clearTimeout(c[t]),c[t]=setTimeout(function(){return O(H,x,C,E),delete c[t]},100)}),h||H.hover(function(){U=!1,O(H,x,C,E),k(E)},function(){U=!0,L||w(E)}),E.bind(i,function(){return d=!0,m.noMoveMouse=!1,!0}),H.bind(i,function(t){return _(t,H,x,C,E),!0}),t(document).bind(s,function(t){return _(t,H,x,C,E),!0}),t(document).bind(n,function(t){return _(t,H,x,C,E),!0}),H.on(o,function(t){var e;return e=y(t,H,x,C,E),v(e,H,x,C,E),!1}))},n=function(){function e(t,e){this.usersVisibilityCss="invisibleDep",this.lastFilteredUsers=[],this.isSorted=!1,this.visible=!0,this.users=[],this.id=t&&"00000000-0000-0000-0000-000000000000"!==t?t:this.withoutDepName,this.name=this.id!==this.withoutDepName&&e?e:this.langs.panel.withoutDepartment,this.isOpen=null!=this.config().departmentVisibility[this.id]?this.config().departmentVisibility[this.id]:!0}return e.prototype.logGroup="Department",e.prototype.getEl=function(e){var n=this;return this.log("get el, usersVisible - "+e+" , for department "+this.getInfo()),this.el||(this.el=t(this.template.replace(/\{\{department}\}/g,b(this.name))),this.el.find(".b_department_header").bind("click",function(){return n.showUsers()})),e?(this._oldIsOpen=this.isOpen,this.showUsers(!0,!0)):this.showUsers(null!=this._oldIsOpen?this._oldIsOpen:this.isOpen),this.el},e.prototype.getContainer=function(){return this.el.find("tbody")},e.prototype.showUsers=function(t,e){var n;return t===void 0&&(t=!this.isOpen),this.hideEl||(this.hideEl=this.el.find("table")),this.log("department users visibility set "+t+" , without save - "+e+". For "+this.getInfo()),this.hideEl.stop(!0,!0),e||(this.isOpen=t,n=this.config(),n.departmentVisibility[this.id]=this.isOpen,this.config(n)),t?(this.el.toggleClass(this.usersVisibilityCss,!1),this.hideEl.show()):(this.el.toggleClass(this.usersVisibilityCss,!0),this.hideEl.hide())},e.prototype.getInfo=function(){return this.name+" "+this.id},e.prototype.clearUsers=function(){return this.users=[]},e.prototype.show=function(t){return this.el&&!this.visible?(t?this.el.slideDown(200):this.el.show(),this.visible=!0):void 0},e.prototype.hide=function(t){return this.el&&this.visible?(t?this.el.slideUp(200):this.el.hide(),this.visible=!1):void 0},e.prototype.getUsers=function(t,e){var n,s,i,o,r,l,a,u,h;if(this.isSorted||this.sortUsers(),i=[],n=!1,""===t)if(e)i=[].concat(this.users);else for(u=this.users,o=0,l=u.length;l>o;o++)s=u[o],0!==s.state&&i.push(s);else for(h=this.users,r=0,a=h.length;a>r;r++)s=h[r],s.isFiltered(t,e)&&(i.push(s),s.number!==t||n||(n=s));return this.lastFilteredUsers=i,[i,n]},e.prototype.sortUsers=function(){return this.users.sort(this.sortFn)},e.prototype.sortFn=function(t,e){return t.nameLower>e.nameLower?1:t.nameLower<e.nameLower?-1:t.number>e.number?1:t.number<e.number?-1:0},e.prototype.addUser=function(t){return t.number?this.users.push(t):void 0},e}(),e=function(){function e(e){this.doAction=__bind(this.doAction,this),this.state=!1,this.hasHover=!1,this.buttonLastAction="",this.firstLiCssPrefix="m_button_action_",this.els=t(),this.buttonEls=t(),this.init(e)}return e.prototype.logGroup="User",e.prototype.init=function(t){var e,n,s,i,o,r,l,a,u,h,c;return this.id=null!=(n=t.id)?(""+n).toLowerCase():void 0,this.isFantom=t.isFantom||!1,this.number=(null!=(s=t.number)?""+s:void 0)||"",this.number||(this.invisible=!0),this.numberFormatted=(null!=(i=t.numberFormatted)?""+i:void 0)||this.number,this.numberHtml=b(this.numberFormatted),this.name=(null!=(o=t.name)?""+o:void 0)||"",this.nameLower=this.name.toLowerCase(),this.letter=(null!=(r=this.name[0])?r.toUpperCase():void 0)||(null!=(l=this.number)?(""+l[0]).toLowerCase():void 0),this.nameHtml=t.name&&""+t.name!==this.number?b(t.name):this.numberHtml,e=this.elNumberHtml,this.elNumberHtml=this.numberHtml!==this.nameHtml?this.numberHtml:"",this.elNumberHtml!==e&&null!=this.el&&this.el.find(".o_number").text(this.elNumberHtml),null!=(a=this.el)&&a.find(".b_contact_title b").text(this.nameHtml),this.avatarLink32x32=t.avatarLink32x32||this.defaultAvatar32||"",this.defaultAvatarCss=this.avatarLink32x32?"":"m_default",this.departmentId=(null!=t?null!=(u=t.numberObj)?u.departmentid:void 0:void 0)&&"00000000-0000-0000-0000-000000000000"!==(null!=t?t.numberObj.departmentid:void 0)?null!=t?t.numberObj.departmentid:void 0:this.withoutDepName,this.department="www_without"===this.departmentId?this.langs.panel.withoutDepartment:null!=t?null!=(h=t.numberObj)?h.department:void 0:void 0,null!=(null!=(c=t.numberObj)?c.state:void 0)?this.setState(t.numberObj.state):null!=t.state?this.setState(t.state):this.setState(1),this.loadActions()},e.prototype.regexps={name:/\{\{name\}\}/,number:/\{\{number\}\}/,avatarLink32x32:/\{\{avatarLink32x32\}\}/,css:/\{\{css\}\}/,letter:/\{\{letter\}\}/},e.prototype.setState=function(t){var e=this;return t=parseInt(t),t!==this.state?(this.state=t,this.setStateCss(),this.buttonEls.length?(this.loadActions(),setTimeout(function(){return e.loadActions()},100)):void 0):void 0},e.prototype.setStateCss=function(){return this.els.length?0===this.state?this.els.removeClass("m_busy").addClass("m_offline"):5===this.state?this.els.removeClass("m_offline").addClass("m_busy"):this.els.removeClass("m_offline").removeClass("m_busy"):void 0},e.prototype.getInfo=function(){return'"'+this.number+'" '+this.state+" "+this.name},e.prototype.isFiltered=function(t,e){return t&&"string"==typeof t||!e&&(e||0===this.state)?(e||!e&&0!==this.state)&&(this.number&&-1!==this.number.indexOf(t)||-1!==(" "+this.name).toLowerCase().indexOf(t))?!0:!1:!0},e.prototype.showLetter=function(t){var e;return null!=(e=this.el)?e.find(".b_capital_letter span").text(t?this.letter:""):void 0},e.prototype.getEl=function(e){var n,s;return(!this.el||e)&&(s=this.template.replace(this.regexps.name,this.nameHtml).replace(this.regexps.number,this.numberHtml!==this.nameHtml?this.numberHtml:"").replace(this.regexps.avatarLink32x32,this.avatarLink32x32).replace(this.regexps.css,this.defaultAvatarCss),n=t(s),n.data("user",this),this.initButtonEl(n.find(".oktell_button_action")),this.els=this.els.add(n),this.setStateCss(),this.el||(this.el=n)),n=n||this.el},e.prototype.initButtonEl=function(t){var e=this;return this.buttonEls=this.buttonEls.add(t),t.data("user",this),t.children(":first").bind("click",function(){return e.doAction(e.buttonLastAction)}),this.buttonLastAction?t.addClass(this.firstLiCssPrefix+this.buttonLastAction.toLowerCase()):void 0},e.prototype.getButtonEl=function(){var e;return e=t(this.buttonTemplate),this.initButtonEl(e),e},e.prototype.isHovered=function(t){return this.hasHover!==t?(this.hasHover=t,this.hasHover?this.loadActions():void 0):void 0},e.prototype.loadOktellActions=function(){var t;return t=this.oktell.getPhoneActions(this.id||this.number)},e.prototype.loadActions=function(){var t,e;return e=this.loadOktellActions(),t=(null!=e?e[0]:void 0)||"",this.buttonLastAction===t?e:(this.buttonLastAction&&this.buttonEls.removeClass(this.firstLiCssPrefix+this.buttonLastAction.toLowerCase()),t?(this.buttonLastAction=t,this.buttonEls.addClass(this.firstLiCssPrefix+this.buttonLastAction.toLowerCase())):this.buttonLastAction="",e)},e.prototype.doAction=function(t){var e;if(t)switch(e=this.number,"function"==typeof this.beforeAction&&this.beforeAction(t),t){case"call":return this.oktell.call(e);case"conference":return this.oktell.conference(e);case"intercom":return this.oktell.intercom(e);case"transfer":return this.oktell.transfer(e);case"toggle":return this.oktell.toggle();case"ghostListen":return this.oktell.ghostListen(e);case"ghostHelp":return this.oktell.ghostHelp(e);case"ghostConference":return this.oktell.ghostConference(e);case"endCall":return this.oktell.endCall(e)}},e.prototype.doLastFirstAction=function(){return this.buttonLastAction?(this.doAction(this.buttonLastAction),!0):!1},e.prototype.letterVisibility=function(t){return this.el&&this.el.length?t?this.el.find(".b_capital_letter span").text(this.letter):this.el.find(".b_capital_letter span").text(""):void 0},e}(),i=function(){function s(s,i,o,r,l){var a,u,h,c,p,f=this;this.defaultConfig={departmentVisibility:{},showDeps:!0,showOffline:!1},this.allActions={call:{icon:"/img/icons/action/call.png",iconWhite:"/img/icons/action/white/call.png",text:this.langs.call},conference:{icon:"/img/icons/action/confinvite.png",iconWhite:"/img/icons/action/white/confinvite.png",text:this.langs.conference},transfer:{icon:"/img/icons/action/transfer.png",text:this.langs.transfer},toggle:{icon:"/img/icons/action/toggle.png",text:this.langs.toggle},intercom:{icon:"/img/icons/action/intercom.png",text:this.langs.intercom},endCall:{icon:"/img/icons/action/endcall.png",iconWhite:"/img/icons/action/white/endcall.png",text:this.langs.endCall},ghostListen:{icon:"/img/icons/action/ghost_monitor.png",text:this.langs.ghostListen},ghostHelp:{icon:"/img/icons/action/ghost_help.png",text:this.langs.ghostHelp}},this.actionCssPrefix="i_",this.lastDropdownUser=!1,p=this,e.prototype.beforeAction=function(t){return p.beforeUserAction(this,t)},this.departments=[],this.departmentsById={},this.simpleListEl=t(this.usersTableTemplate),this.filterFantomUserNumber=!1,this.userWithGeneratedButtons={},this.debugMode=l,this.dropdownPaddingBottomLeft=3,this.dropdownOpenedOnPanel=!1,this.regexps={actionText:/\{\{actionText\}\}/,action:/\{\{action\}\}/,css:/\{\{css\}\}/,dep:/\{\{department}\}/g},c=!1,this.usersByNumber={},this.me=!1,this.oktell=s,this.panelUsers=[],this.panelUsersFiltered=[],this.abonents={},this.hold={},this.queue={},this.oktell=s,e.prototype.oktell=s,this.filter=!1,this.panelEl=i,this.dropdownEl=o,this.dropdownElLiTemplate=this.dropdownEl.html(),this.dropdownEl.empty(),this.keypadEl=this.panelEl.find(".j_phone_keypad"),this.keypadIsVisible=!1,this.usersListBlockEl=this.panelEl.find(".j_main_list"),this.usersListEl=this.simpleListEl.find("tbody"),this.abonentsListBlock=this.panelEl.find(".j_abonents"),this.abonentsListEl=this.abonentsListBlock.find("tbody"),this.talkTimeEl=this.abonentsListBlock.find(".b_marks_time"),this.holdBlockEl=this.panelEl.find(".j_hold"),this.holdListEl=this.holdBlockEl.find("tbody"),this.queueBlockEl=this.panelEl.find(".j_queue"),this.queueListEl=this.queueBlockEl.find("tbody"),this.filterInput=this.panelEl.find("input"),this.filterClearCross=this.panelEl.find(".jInputClear_close"),a=!1,this.buttonShowOffline=this.panelEl.find(".b_list_filter .i_online"),this.buttonShowDeps=this.panelEl.find(".b_list_filter .i_group"),this.buttonShowOffline.bind("click",function(){return f.config({showOffline:!f.showOffline}),f.setFilter(f.filter,!0)}),this.buttonShowDeps.bind("click",function(){return f.config({showDeps:!f.showDeps}),f.setFilter(f.filter,!0)}),this.usersWithBeforeConnectButtons=[],this.config(),n.prototype.config=function(){var t;return t=arguments.length>=1?__slice.call(arguments,0):[],f.config.apply(f,t)},this.allUserDep=new n("all_user_dep","allUsers"),this.allUserDep.template=this.usersTableTemplate,this.exactMatchUserDep=new n("exact_match_user_dep","exactUser"),this.exactMatchUserDep.template=this.usersTableTemplate,this.userScrollerToTop=function(){return f._jScrolled||(f.jScroll(f.usersListBlockEl),f.usersScroller=f.usersListBlockEl.find(".jscroll_scroller")),f.usersScroller.css({top:"0px"})},this.filterClearCross.bind("click",function(){return f.clearFilter()}),this.filterInput.bind("keyup",function(t){return f.oktellConnected?(a||(a=d(function(){return f.setFilter((""+f.filterInput.val()).toLowerCase())},100)),f.filterInput.val()?f.filterClearCross.show():f.filterClearCross.hide(),13===t.keyCode?(f.filterInput.blur(),setTimeout(function(){var t;return null!=(t=f.usersListBlockEl.find("tr:first").data("user"))&&t.doLastFirstAction(),f.clearFilter()},50)):a(),!0):!0}),this.panelEl.bind("click",function(e){var n,s,i,o;return i=t(e.target),i.is(".oktell_button_action .g_first")?n=i.parent():i.is(".oktell_button_action .g_first i")?n=i.parent().parent():i.is(".b_contact .drop_down")?s=i.parent():i.is(".b_contact .drop_down i")&&(s=i.parent().parent()),null==n&&null==s||n&&0===n.size()||s&&0===s.size()?!0:null!=n&&n.size()?(o=n.data("user"),null!=o&&o.doLastFirstAction(),!0):null!=s&&s.size()?(o=s.data("user"),o&&f.showDropdown(o,s,o.loadOktellActions(),!0),!0):void 0}),this.dropdownEl.bind("click",function(e){var n,s,i,o;if(i=t(e.target),i.is("[data-action]"))s=i;else{if(0===i.closest("[data-action]").size())return!0;s=i.closest("[data-action]")}return(n=s.data("action"))?(o=f.dropdownEl.data("user"),n&&o&&o.doAction(n),f.dropdownEl.hide()):void 0}),h="",this.dropdownEl.hover(function(){return clearTimeout(h)},function(){return h=setTimeout(function(){return f.dropdownEl.fadeOut(150,function(){return f.dropdownOpenedOnPanel=!1})},500)}),this.panelEl.find(".j_keypad_expand").bind("click",function(){return f.toggleKeypadVisibility(),f.filterInput.focus()}),this.keypadEl.find("li").bind("click",function(e){return f.filterInput.focus(),f.filterInput.val(f.filterInput.val()+t(e.currentTarget).find("button").data("num")),f.filterInput.keyup()}),this.setUserListHeight=function(){return f.usersListBlockEl.css({height:t(window).height()-f.usersListBlockEl[0].offsetTop+"px"})},this.setUserListHeight(),u=d(function(){return f.userScrollerToTop(),f.setUserListHeight()},50),t(window).bind("resize",function(){return u()}),s.on("disconnect",function(){var t,e,n,s;f.oktellConnected=!1,f.usersByNumber={},f.panelUsers=[],f.setPanelUsersHtml([]),f.setAbonents([]),f.setHold({hasHold:!1}),f.filterInput.val(""),f.setFilter("",!0),f.setQueue([]),n=f.userWithGeneratedButtons,s=[];for(t in n)e=n[t],s.push(e.loadActions());return s}),s.on("connect",function(){var t,i,o,l,a,u,h,c,d,p,m,g,b,_;f.oktellConnected=!0,l=s.getMyInfo(),l.userid=(""+l.userid).toLowerCase(),f.myNumber=null!=(g=l.number)?""+g:void 0,e.prototype.defaultAvatar=l.defaultAvatar,e.prototype.defaultAvatar32=l.defaultAvatar32x32,e.prototype.defaultAvatar64=l.defaultAvatar64x64,f.departments=[],f.departmentsById={},t={},h=new n,u=s.getUsers();for(o in u)__hasProp.call(u,o)&&(a=u[o],c=(null!=(b=a.number)?""+b:void 0)||"",c&&(f.usersByNumber[c]?(d=f.usersByNumber[c],a.isFantom=!1,d.init(a)):(d=new e(a),d.number&&(f.usersByNumber[d.number]=d)),d.id!==l.userid?(f.panelUsers.push(d),d.departmentId&&"00000000-0000-0000-0000-000000000000"!==d.departmentId?(t[d.departmentId]?i=t[d.departmentId]:(i=t[d.departmentId]=new n(d.departmentId,d.department),f.departments.push(i),f.departmentsById[d.departmentId]=i),i.addUser(d)):h.addUser(d),f.allUserDep.addUser(d)):f.me=d));for(f.departments.sort(function(t,e){return t.name>e.name?1:e.name>t.name?-1:0}),f.departments.push(h),s.on("stateChange",function(){return f.reloadActions()}),s.onNativeEvent("pbxnumberstatechanged",function(t){var e,n,s,o,r,l,a,u,h,c,p,m,g,b;for(u=t.numbers,b=[],l=0,a=u.length;a>l;l++)n=u[l],s=""+n.num,d=f.usersByNumber[s],d?(f.log(""),f.log("start user state change from "+d.state+" to "+n.numstateid+" for "+d.getInfo()),i=f.showDeps?f.departmentsById[d.departmentId]:f.allUserDep,f.log("current visibility settings are ShowDeps="+f.showDeps+" and ShowOffline="+f.showOffline),r=d.isFiltered(f.filter,f.showOffline),f.log("user was filtered earlier = "+r),d.setState(n.numstateid),o=d.isFiltered(f.filter,f.showOffline),f.log("after user.setState, now user filtered = "+o),o?r||(f.log("user now filtered and was not filtered before state change"),i.getUsers(f.filter,f.showOffline),f.log("refilter all user of department "+i.getInfo()),e=i.lastFilteredUsers.indexOf(d),f.log("index of user in refiltered users list is "+e),-1!==e&&(i.getContainer().is(":visible")?(0===e?(f.log("add user html to start of department container"),i.getContainer().prepend(d.getEl())):(f.log("add user html after prev user html element"),null!=(c=i.lastFilteredUsers[e-1])&&null!=(p=c.el)&&p.after(d.getEl())),(null!=(m=i.lastFilteredUsers[e-1])?m.letter:void 0)===d.letter?(f.log("hide user letter because it is like prev user letter "+d.letter),d.letterVisibility(!1)):(null!=(g=i.lastFilteredUsers[e+1])?g.letter:void 0)===d.letter&&(f.log("hide prev user letter because it is like user letter "+d.letter),i.lastFilteredUsers[e+1].letterVisibility(!1))):(f.log("dep container is hidden, so, refilter all users list"),f.setFilter(f.filter,!0)))):(f.log("now user isnt filtered"),1===i.getContainer().children().length?(f.log("container contains only users el, so refilter all list"),f.setFilter(f.filter,!0)):(f.log("remove his html element"),null!=(h=d.el)&&"function"==typeof h.remove&&h.remove())),f.log("end user state change"),b.push(f.log(""))):b.push(void 0);return b}),s.on("abonentsChange",function(t){return f.setAbonents(t),f.reloadActions()}),s.on("holdStateChange",function(t){return f.setHold(t),f.reloadActions()}),s.on("talkTimer",function(t,e){return t===!1?f.talkTimeEl.text(""):f.talkTimeEl.text(e)}),f.setAbonents(s.getAbonents()),f.setHold(s.getHoldInfo()),f.setFilter("",!0),s.on("queueChange",function(t){return f.setQueue(t)}),s.getQueue(function(t){return t.result?f.setQueue(t.queue):void 0}),_=f.usersWithBeforeConnectButtons,p=0,m=_.length;m>p;p++)d=_[p],d.loadActions();return"function"==typeof r?r():void 0})}return s.prototype.logGroup="List",s.prototype.getUserButtonForPlugin=function(t){var e,n,s=this;return n=this.getUser(t),this.oktellConnected||this.usersWithBeforeConnectButtons.push(n),this.userWithGeneratedButtons[t]=n,e=n.getButtonEl(),e.find(".drop_down").bind("click",function(){var t;return t=n.loadActions(),s.showDropdown(n,e,t)}),e},s.prototype.clearFilter=function(){return this.filterInput.val(""),this.setFilter(""),this.filterInput.keyup()},s.prototype.toggleKeypadVisibility=function(){return this.setKeypadVisibility(!this.keypadIsVisible)},s.prototype.setKeypadVisibility=function(t){return null!=t&&Boolean(this.keypadIsVisible)!==Boolean(t)?(this.keypadIsVisible=Boolean(t),this.keypadEl.stop(!0,!0),this.keypadIsVisible?this.keypadEl.slideDown({duration:200,easing:"linear",done:this.setUserListHeight}):this.keypadEl.slideUp({duration:200,easing:"linear",done:this.setUserListHeight})):void 0},s.prototype.addEventListenersForButton=function(e,n){var s=this;return n.bind("click",function(){return e?s.showDropdown(e,t(s)):void 0})},s.prototype.showDropdown=function(e,n,s,i){var o,r,l,a,u,h;if(l=this.dropdownElLiTemplate,this.dropdownEl.empty(),null!=s?!s.length:true)return this.dropdownEl.hide();for(r=[],a=0,u=s.length;u>a;a++)o=s[a],"string"==typeof o&&(null!=(h=this.allActions[o])?h.text:void 0)&&r.push(l.replace(this.regexps.actionText,this.allActions[o].text).replace(this.regexps.action,o).replace(this.regexps.css,this.actionCssPrefix+o.toLowerCase()));return r.length?(this.dropdownEl.append(r),this.dropdownEl.children("li:first").addClass("g_first"),this.dropdownEl.children("li:last").addClass("g_last"),this.dropdownEl.data("user",e),this.dropdownEl.css({top:this.dropdownEl.height()+n.offset().top>t(window).height()?t(window).height()-this.dropdownEl.height()-this.dropdownPaddingBottomLeft:n.offset().top,left:Math.max(this.dropdownPaddingBottomLeft,n.offset().left-this.dropdownEl.width()+n.width()),visibility:"visible"}),this.dropdownEl.fadeIn(100),i?this.dropdownOpenedOnPanel=!0:void 0):this.dropdownEl.hide()},s.prototype.logUsers=function(){var t,e,n,s;n=this.panelUsersFiltered,s=[];for(t in n)__hasProp.call(n,t)&&(e=n[t],s.push(U(e.getInfo())));return s},s.prototype.syncAbonentsAndUserlist=function(e,n){var s,i,o,r,l=this;s={},t.each(e,function(t,e){var i,o;if(e&&(i=""+e.phone||""))return s[i]=e,n[""+e.phone]?void 0:(o=l.getUser({name:e.name,number:e.phone,id:e.userid,state:1}),n[o.number]=o)}),r=[];for(i in n)__hasProp.call(n,i)&&(o=n[i],s[o.number]?r.push(void 0):r.push(delete n[o.number]));return r},s.prototype.setAbonents=function(t){return this.syncAbonentsAndUserlist(t,this.abonents),this.setAbonentsHtml()},s.prototype.setQueue=function(t){var e,n,s,i,o,r;if("ring"===this.oktell.getState())for(n=i=0,o=t.length;o>i;n=++i)e=t[n],this.abonents[e.phone]&&delete t[n];this.syncAbonentsAndUserlist(t,this.queue),r=this.queue;for(n in r)__hasProp.call(r,n)&&(s=r[n],s.loadActions());return this.setQueueHtml()},s.prototype.setHold=function(t){var e;return e=[],t.hasHold&&(e=[t.abonent]),this.syncAbonentsAndUserlist(e,this.hold),this.setHoldHtml()},s.prototype.setPanelUsersHtml=function(t){return this._setUsersHtml(t,this.usersListEl),this.userScrollerToTop()},s.prototype.setAbonentsHtml=function(){return this._setActivityPanelUserHtml(this.abonents,this.abonentsListEl,this.abonentsListBlock)},s.prototype.setHoldHtml=function(){return this._setActivityPanelUserHtml(this.hold,this.holdListEl,this.holdBlockEl)},s.prototype.setQueueHtml=function(){return this._setActivityPanelUserHtml(this.queue,this.queueListEl,this.queueBlockEl)},s.prototype._setActivityPanelUserHtml=function(t,e,n){var s,i,o;o=[];for(s in t)__hasProp.call(t,s)&&(i=t[s],o.push(i));return this._setUsersHtml(o,e,!0),o.length&&n.is(":not(:visible)")?n.slideDown(200,this.setUserListHeight):0===o.length&&n.is(":visible")?n.slideUp(200,this.setUserListHeight):void 0},s.prototype._setUsersHtml=function(t,e,n){var s,i,o,r,l,a;for(s=[],i=null,o="",l=0,a=t.length;a>l;l++)r=t[l],s.push(r.getEl(n)),r.showLetter(o!==r.letter?!0:!1),o=r.letter;return e.children().detach(),e.html(s)},s.prototype.setFilter=function(t,e){var n,s,i,o,r,l,a,u,h,c=this;if(this.filter===t&&!e)return!1;if(r=this.filter,this.filter=t,o=!1,this.timer(),n=[],l=function(e){var s,i,r,l;return i=e.getEl(""!==t),s=!1,l=e.getUsers(t,c.showOffline),r=l[0],s=l[1],0!==r.length?(o||(o=s),c._setUsersHtml(r,e.getContainer()),s&&o===s?n.unshift(i):n.push(i)):void 0},this.showDeps)for(h=this.departments,a=0,u=h.length;u>a;a++)s=h[a],l(s);else l(this.allUserDep);return!o&&t.match(/[0-9\(\)\+\-]/)?(this.filterFantomUser=this.getUser({name:t,number:t},!0),this.exactMatchUserDep.clearUsers(),this.exactMatchUserDep.addUser(this.filterFantomUser),i=this.exactMatchUserDep.getEl(),this._setUsersHtml([this.filterFantomUser],this.exactMatchUserDep.getContainer()),this.filterFantomUser.showLetter(!1),n.unshift(i)):this.filterFantomUser=!1,this.usersListBlockEl.children().detach(),this.usersListBlockEl.html(n),this.userScrollerToTop(),this.timer(!0)},s.prototype.afterSetFilter=function(t){return this.setPanelUsersHtml(t)},s.prototype.getUser=function(t,n){var s,i,o,r;return"string"==typeof t||"number"==typeof t?(o=""+t,t={number:o}):o=""+t.number,i=t.phoneFormatted||("function"==typeof O.formatPhone?O.formatPhone(o):void 0)||o,t.numberFormatted||(t.numberFormatted=i),n||(null!=(r=this.filterFantomUser)?r.number:void 0)!==o||(this.usersByNumber[o]=this.filterFantomUser,t.isFantom=!0,this.filterFantomUser=!1),this.usersByNumber[o]?(this.usersByNumber[o].isFantom&&this.usersByNumber[o].init(t),this.usersByNumber[o]):(s=new e({number:o,numberFormatted:i,name:t.name,isFantom:!0,state:null!=(null!=t?t.state:void 0)?t.state:1}),n||(this.usersByNumber[o]=s),s)},s.prototype.reloadActions=function(){var t=this;return setTimeout(function(){var e,n,s,i,o,r,l,a;i=t.userWithGeneratedButtons;for(n in i)__hasProp.call(i,n)&&(s=i[n],e=s.loadActions());o=t.abonents;for(n in o)s=o[n],s.loadActions();r=t.queue;for(n in r)s=r[n],s.loadActions();l=t.panelUsersFiltered,a=[];for(n in l)s=l[n],a.push(s.loadActions());return a},100)},s.prototype.timer=function(t){return t&&this._time&&this.log("List timer stop: "+(Date.now()-this._time)),t?void 0:(this._time=Date.now(),U("List timer start"))},s.prototype.beforeUserAction=function(t){return this.filterFantomUser&&t===this.filterFantomUser?this.clearFilter():void 0},s.prototype.config=function(t){var e,n,s,i;if(!this._config){if(("undefined"!=typeof localStorage&&null!==localStorage?localStorage.oktellPanel:void 0)&&("undefined"!=typeof JSON&&null!==JSON?JSON.parse:void 0)){try{this._config=JSON.parse(localStorage.oktellPanel)}catch(o){e=o}(null==this._config||"object"!=typeof this._config)&&(this._config={})}else this._config={};i=this.defaultConfig;for(n in i)__hasProp.call(i,n)&&(s=i[n],null==this._config[n]&&(this._config[n]=s))}if(null!=t){for(n in t)__hasProp.call(t,n)&&(s=t[n],this._config[n]=s);localStorage&&("undefined"!=typeof JSON&&null!==JSON?JSON.stringify:void 0)&&localStorage.setItem("oktellPanel",JSON.stringify(this._config))}return this.showDeps=this._config.showDeps,this.showOffline=this._config.showOffline,this.buttonShowOffline.toggleClass("g_active",!this.showOffline),this.buttonShowDeps.toggleClass("g_active",this.showDeps),this._config},s}(),o=function(){function e(t,e){var n=this;this.el=t,this.absContainer=this.el.find(".b_content"),this.abonentEl=this.absContainer.find(".b_abonent").remove(),this.isBack101=!1,this.el.find(".j_abort_action").bind("click",function(){return n.hide(),e.endCall()}),this.el.find(".j_close_action").bind("click",function(){return n.hide()}),this.el.find("i.o_close").bind("click",function(){return n.hide()}),e.on("ringStart",function(t){return n.isBack101||n.setAbonents(t),n.show()}),e.on("ringStop",function(){return n.isBack101=!1,n.hide()})}return e.prototype.logGroup="Popup",e.prototype.show=function(){return this.el.fadeIn(200)},e.prototype.hide=function(){return this.el.fadeOut(200),this.isBack101=!1},e.prototype.setAbonents=function(e){var n=this;return this.absContainer.empty(),t.each(e,function(t,e){var s,i,o;return o=""+e.phone,i=""+e.name||o,i===o&&(o=""),s=n.abonentEl.clone(),s.find("span:first").text(i),s.find("span:last").text(o),n.absContainer.append(s)})},e}(),s=function(){function t(t,e){var n=this;this.el=t,e.on("disconnect",function(t){return n.log("disconnect with reason "+t.code+" "+t.message),12===t.code?n.show(3,e.getMyInfo().login):void 0}),e.on("connectError",function(t){switch(n.log("connect error "+t.errorCode+" "+t.errorMessage),t.errorCode){case 12:return n.show(1,e.getMyInfo().login);case 13:return n.show(2,e.getMyInfo().login)}})}return t.prototype.logGroup="Error",t.prototype.errorTypes={1:"usingOktellClient",2:"loginPass",3:"unavailable"},t.prototype.show=function(t,e){var n,s,i;return this.errorTypes[t]?(this.log("show "+t),n=this.errorTypes[t],this.el.find("p:eq(0)").text(this.langs[n].header.replace("%username%",e)),this.el.find("p:eq(1)").text((null!=(s=this.langs[n].message)?s.replace("%username%",e):void 0)||""),this.el.find("p:eq(3)").text((null!=(i=this.langs[n].message2)?i.replace("%username%",e):void 0)||""),this.el.fadeIn(200)):!1},t.prototype.hide=function(){return this.el.fadeOut(200)},t}(),p={position:"right",dynamic:!1,oktell:window.oktell,debug:!1,lang:"ru",noavatar:!0},C={ru:{panel:{inTalk:"В разговоре",onHold:"На удержании",queue:"Очередь ожидания",inputPlaceholder:"введите имя или номер",withoutDepartment:"без отдела"},actions:{call:"Позвонить",conference:"Конференция",transfer:"Перевести",toggle:"Переключиться",intercom:"Интерком",endCall:"Завершить",ghostListen:"Прослушка",ghostHelp:"Помощь"},callPopup:{title:"Входящий вызов",hide:"Скрыть",answer:"Ответить",reject:"Отклонить",undefinedNumber:"Номер не определен",goPickup:"Поднимите трубку"},error:{usingOktellClient:{header:"Пользователь «%username%» использует стандартный Oktell-клиент.",message:"Одновременная работа двух типов клиентских приложений невозможна.",message2:"Закройте стандартный Oktell-клиент и повторите попытку."},loginPass:{header:"Пароль для пользователя «%username%» не подходит.",message:"Проверьте правильность имени пользователя и пароля."},unavailable:{header:"Сервер телефонии Oktell не доступен.",message:"Убедитесь что сервер телефонии работает и проверьте настройки соединения."}}},en:{panel:{inTalk:"In conversation",onHold:"On hold",queue:"Wait queue",inputPlaceholder:"Enter name or number",withoutDepartment:"wihtout department"},actions:{call:"Dial",conference:"Conference",transfer:"Transfer",toggle:"Switch",intercom:"Intercom",endCall:"End",ghostListen:"Audition",ghostHelp:"Help"},callPopup:{title:"Incoming call",hide:"Hide",answer:"Answer",reject:"Decline",undefinedNumber:"Phone number is not defined",goPickup:"Pick up the phone"},error:{usingOktellClient:{header:"User «%username%» uses standard Oktell client applications.",message:"Simultaneous work of two types of client applications is not possible..",message2:"Close standard Oktell client application and try again."},loginPass:{header:"Wrong password for user «%username%».",message:"Make sure that the username and password are correct."},unavailable:{header:"Oktell server is not available.",message:"Make sure that Oktell server is running and check your connections."}}},cz:{panel:{inTalk:"V rozhovoru",onHold:"Na hold",queue:"Fronta čekaní",inputPlaceholder:"zadejte jméno nebo číslo",withoutDepartment:"!!!!!!!"},actions:{call:"Zavolat",conference:"Konference",transfer:"Převést",toggle:"Přepnout",intercom:"Intercom",endCall:"Ukončit",ghostListen:"Odposlech",ghostHelp:"Nápověda"},callPopup:{title:"Příchozí hovor",hide:"Schovat",answer:"Odpovědět",reject:"Odmítnout",undefinedNumber:"",goPickup:"Zvedněte sluchátko"},error:{usingOktellClient:{header:"User «%username%» uses standard Oktell client applications.",message:"Simultaneous work of two types of client applications is not possible..",message2:"Close standard Oktell client application and try again."},loginPass:{header:"Wrong password for user «%username%».",message:"Make sure that the username and password are correct."},unavailable:{header:"Oktell server is not available.",message:"Make sure that Oktell server is running and check your connections."}}}},P=null,l=null,O=null,A=!1,h=null,E=null,B=null,m=null,_=function(){return P||p
},L="",U=function(){var t,e,n,s,i,o,r,l,a,u;if(t=arguments.length>=1?__slice.call(arguments,0):[],_().debug){for(e=new Date,n=e.getFullYear()+"-"+(10>e.getMonth()?"0":"")+e.getMonth()+"-"+(10>e.getDate()?"0":"")+e.getDate(),r=(10>e.getHours()?"0":"")+e.getHours()+":"+(10>e.getMinutes()?"0":"")+e.getMinutes()+":"+(10>e.getSeconds()?"0":"")+e.getSeconds()+":"+(""+(e.getMilliseconds()+1e3)).substr(1),L+=n+" "+r+" | ",i="log","error"===(""+t[0]).toLowerCase()&&(i="error"),o=a=0,u=t.length;u>a;o=++a){if(l=t[o],"object"==typeof l)try{L+=JSON.stringify(l)}catch(h){s=h,L+=""+l}else L+=l;L+=" | "}L+="\n\n",t.unshift("Oktell-Panel.js "+r+" |"+("string"==typeof this.logGroup?" "+this.logGroup+" |":""));try{return console[i].apply(console,t||[])}catch(h){s=h}}},F={"templates/actionButton.html":'<ul class="oktell_button_action"><li class="g_first"><i></i></li><li class="g_last drop_down"><i></i></li></ul>',"templates/actionList.html":'<ul class="oktell_actions_group_list"><li class="{{css}}" data-action="{{action}}"><i></i><span>{{actionText}}</span></li></ul>',"templates/user.html":'<tr class="b_contact"><td class="b_contact_avatar {{css}}"><img src="{{avatarLink32x32}}"><i></i><div class="o_busy"></div></td><td class="b_capital_letter"><span></span></td><td class="b_contact_title"><div class="wrapword"><a><b>{{name}}</b><span class="o_number">{{number}}</span></a></div>{{button}}</td></tr>',"templates/department.html":'<tr class="b_contact"><td class="b_contact_department" colspan="3">{{department}}</td></tr>',"templates/dep.html":'<div><div class="b_department_header"><span>{{department}}</span></div><table class="b_main_list"><tbody></tbody></table></div>',"templates/usersTable.html":'<table class="b_main_list"><tbody></tbody></table>',"templates/panel.html":'<div class="oktell_panel"><div class="i_panel_bookmark"><div class="i_panel_bookmark_bg"></div></div><div class="h_panel_bg"><div class="b_header"><ul class="b_list_filter"><li class="i_group"></li><li class="i_online"></li></ul></div><div class="h_padding"><div class="b_marks i_conference j_abonents"><div class="b_marks_noise"><p class="b_marks_header"><span class="b_marks_label">{{inTalk}}</span><span class="b_marks_time"></span></p><table><tbody></tbody></table></div></div><div class="b_marks i_flash j_hold"><div class="b_marks_noise"><p class="b_marks_header"><span class="b_marks_label">{{onHold}}</span></p><table class="j_table_favorite"><tbody></tbody></table></div></div><div class="b_marks i_flash j_queue"><div class="b_marks_noise"><p class="b_marks_header"><span class="b_marks_label">{{queue}}</span></p><table class="j_table_queue"><tbody></tbody></table></div></div><div class="b_inconversation j_phone_block"><table class="j_table_phone"><tbody></tbody></table></div><div class="b_marks i_phone"><div class="h_shadow_bottom"><div class="h_phone_number_input"><div class="i_phone_state_bg"></div><div class="h_input_padding"><div class="i_phone_popup_button j_keypad_expand"><i></i></div><div class="jInputClear_hover"><input class="b_phone_number_input" type="text" placeholder="{{inputPlaceholder}}"><span class="jInputClear_close">&times;</span></div></div><div class="b_phone_keypad j_phone_keypad"><div class="l_column_group"><div class="h_phone_keypad"><ul class="b_phone_panel"><li class="g_top_left g_first"><button data-num="1" class="g_button m_big">1</button></li><li><button data-num="2" class="g_button m_big">2</button></li><li class="g_top_right g_right"><button data-num="3" class="g_button m_big">3</button></li><li class="g_float_celar g_first"><button data-num="4" class="g_button m_big">4</button></li><li><button data-num="5" class="g_button m_big">5</button></li><li class="g_right"><button data-num="6" class="g_button m_big">6</button></li><li class="g_float_celar g_first"><button data-num="7" class="g_button m_big">7</button></li><li><button data-num="8" class="g_button m_big">8</button></li><li class="g_right"><button data-num="9" class="g_button m_big">9</button></li><li class="g_bottom_left g_float_celar g_first"><button data-num="*" class="g_button m_big">&lowast;</button></li><li class="g_bottom_center"><button data-num="0" class="g_button m_big">0</button></li><li class="g_bottom_right g_right"><button data-num="#" class="g_button m_big">#</button></li></ul></div></div></div></div></div></div><div class="h_main_list j_main_list"></div></div></div></div>',"templates/callPopup.html":'<div class="oktell_panel_popup" style="display: none"><div class="m_popup_staff"><div class="m_popup_data"><header><div class="h_header_bg"><i class="o_close"></i><h2>{{title}}</h2></div></header><div class="b_content"><div class="b_abonent"><span data-bind="text: name"></span>&nbsp;<span class="g_light" data-bind="textPhone: number"></span></div></div><div class="footer"><div class="b_take_phone"><i></i>&nbsp;<span>{{goPickup}}</span></div><button class="oktell_panel_btn m_big j_close_action">{{hide}}</button><button class="oktell_panel_btn m_big m_button_red j_abort_action"><i></i>{{reject}}</button></div></div></div></div>',"templates/error.html":'<div class="b_error" style="display: none"><div class="h_padding"><h4>Ошибка</h4><p class="b_error_alert"></p><p class="g_light"></p><p class="g_light"></p></div></div>'},x=function(e){var n;return"/"===e[0]&&(e=e.substr(1)),null!=F[e]?F[e]:(n="",t.ajax({url:e,async:!1,success:function(t){return n=t}}),n)},r=x("/templates/actionButton.html"),a=x("/templates/actionList.html"),j=x("/templates/user.html"),f=x("/templates/department.html"),f=x("/templates/dep.html"),T=x("/templates/usersTable.html"),H=x("/templates/panel.html"),S=x("/templates/callPopup.html"),g=x("/templates/error.html"),i.prototype.jScroll=k,i.prototype.usersTableTemplate=T,e.prototype.buttonTemplate=r,e.prototype.log=U,i.prototype.log=U,o.prototype.log=U,n.prototype.log=U,s.prototype.log=U,n.prototype.template=f,I=!1,w=function(u){var c,d,b,v,y,w,k,x,U,L,A,F,T,D,N,M,q,V,z,W,G,J,Q,K,R,Y,$,X;return I=!0,P=t.extend(p,u||{}),n.prototype.withoutDepName=i.prototype.withoutDepName="zzzzz_without",C=C[P.lang]||C.ru,e.prototype.template=j.replace("{{button}}",r),H=H.replace("{{inTalk}}",C.panel.inTalk).replace("{{onHold}}",C.panel.onHold).replace("{{queue}}",C.panel.queue).replace("{{inputPlaceholder}}",C.panel.inputPlaceholder),i.prototype.langs=C.actions,i.prototype.departmentTemplate=f,s.prototype.langs=C.error,e.prototype.langs=C,n.prototype.langs=C,G=t(H),_().noavatar&&G.addClass("noavatar"),S=S.replace("{{title}}",C.callPopup.title).replace("{{goPickup}}",C.callPopup.goPickup).replace("{{hide}}",C.callPopup.hide).replace("{{reject}}",C.callPopup.reject),c=t(j),d=t(r),V=d.attr("data-bind"),d.attr("data-bind",V+", visible: $data.actionBarIsVisible"),c.find("td.b_contact_title").append(d),l=t(a),t("body").append(l),O=_().oktell,e.prototype.formatPhone=O.formatPhone,_().withoutCallPopup||(R=t(S),t("body").append(R),B=new o(R,O)),_().withoutError||(T=t(g),G.find(".h_panel_bg:first").append(T),m=new s(T,O)),Q=_().position,v={},v[Q]="0px",b={},b[Q]="-281px",t("body").append(G),E=new i(O,G,l,h,_().debug),_().debug&&(window.wList=E,window.wPopup=B,window.wError=m),"right"===Q?G.addClass("right"):"left"===Q&&G.addClass("left"),_().dynamic&&G.addClass("dynamic"),W=G.find(".i_panel_bookmark"),w={},k="left"===Q?"right":"left",w[k]="0px",y={},y[k]="-40px",M=!1,J=!1,K="closed",N=function(){return clearTimeout(J),J=!1},G.on("mouseenter",function(){return M=!0,N(),0>parseInt(G.css(Q))&&("closed"===K||"closing"===K)&&(K="opening",W.stop(!0,!0),W.animate(w,50,"swing"),G.stop(!0,!0),G.animate(v,100,"swing",function(){return G.addClass("g_hover"),K="open"})),!0}),D=function(){return G.hasClass("g_hover")?(K="closing",G.stop(!0,!0),G.animate(b,300,"swing",function(){return G.css({panelPos:0}),G.removeClass("g_hover"),K="closed"}),setTimeout(function(){return W.animate(y,50,"swing")},150)):void 0},G.on("mouseleave",function(){return M=!1,!0}),t("html").bind("mouseleave",function(){return N(),!0}),t("html").bind("mousemove",function(){return M||J!==!1||E.dropdownOpenedOnPanel||(J=setTimeout(function(){return D()},100)),!0}),-1!==window.navigator.userAgent.indexOf("iPad")&&(X=0,$=0,A=G,F=0,U=0,L=-281,Y=0,q=0,z="j_open",x="j_close",0>parseInt(A[0].style.right)&&A.addClass(x),A.live("click",function(){return A.hasClass(x)?A.animate(v,200,"swing",function(){return A.removeClass(x).addClass(z),Y=0}):void 0}),A.live("touchstart",function(t){return X=t.originalEvent.touches[0].pageX,F=A.width(),U=13*(F/100),L=parseInt(A.css(Q))}),A.bind("touchmove",function(t){return t.preventDefault(),$=t.originalEvent.touches[0].pageX,Y=$-X,q=L-Y,-281>q?q=-281:q>0&&(q=0),A[0].style.right=q+"px"}),A.bind("touchend",function(){return Y>=U&&0>Y?A.animate(b,200,"swing"):void 0}),-1*Y>=U&&Y>0&&A.animate(v,200,"swing"),U>Y&&0>Y&&A.animate(v,100,"swing",function(){return A.removeClass(x).addClass(z)}),U>-1*Y&&Y>0)?A.animate(b,100,"swing",function(){return A.removeClass(z).addClass(x)}):void 0},h=function(){return A=!0},y=function(t){var e,n;return t.addClass(_().buttonCss),n=t.attr("data-phone"),n?(e=E.getUserButtonForPlugin(n),t.html(e)):void 0},u=function(t){return y(t)},v=function(e){return t(e+":not(."+actionButtonContainerClass+")").each(function(){return u(t(this))})},t.oktellPanel=function(t){if("string"==typeof t){if(I)return v(t)}else if(!I)return w(t)},t.fn.oktellButton=function(){return t(this).each(function(){return u(t(this))})}})($);
>>>>>>> develop
